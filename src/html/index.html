<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting - Decentralized Voting System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/index.css">
</head>
<body>
    <script type="module">
        const token = localStorage.getItem("jwtTokenVoter");
        if (!token) {
            alert("Please login first");
            window.location.href = "login.html";
        }
    </script>

    <div class="voting-container">
        <div class="header">
            <div class="back-button">
                <a href="http://localhost:8080" class="back-link">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </a>
            </div>
            <div class="logo">
                <i class="fab fa-ethereum"></i>
            </div>
            <h1 class="main-title">Decentralized Voting</h1>
            <p class="subtitle">Cast Your Vote Securely</p>
            <div class="voting-dates" id="dates"></div>
        </div>

        <!-- Wallet Connection Section -->
        <div class="wallet-section">
            <button id="connectWalletBtn" class="wallet-btn">
                <i class="fas fa-wallet"></i> Connect Wallet
            </button>
            <button id="switchAccountBtn" class="wallet-btn secondary">
                <i class="fas fa-sync-alt"></i> Switch Account
            </button>
            <div id="connectedAddress" class="wallet-address"></div>
        </div>

        <div id="error-message" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span id="error-text"></span>
        </div>

        <div id="success-message" class="success-message" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <span id="success-text"></span>
        </div>

        <div class="voting-content">
            <div class="candidates-section" id="candidatesList">
                <!-- Candidates will be populated here -->
            </div>
            <button id="castVoteBtn" class="cast-vote-btn">
                <i class="fas fa-vote-yea"></i> Cast Vote
            </button>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module">
        import { attachWalletUI, attachSwitchAccountUI } from '../js/wallet.js';
        
        attachWalletUI({ 
            buttonId: 'connectWalletBtn', 
            displayId: 'connectedAddress' 
        });
        
        attachSwitchAccountUI({ 
            buttonId: 'switchAccountBtn', 
            displayId: 'connectedAddress' 
        });

        const token = localStorage.getItem("jwtTokenVoter");
        const headers = { Authorization: `Bearer ${token}` };

        async function loadDates() {
          try {
            const res = await fetch("http://127.0.0.1:8000/dates", { headers });
            const data = await res.json();
            if (data.startDate && data.endDate) {
              const start = new Date(data.startDate);
              const end = new Date(data.endDate);
              document.getElementById("dates").textContent = `${start.toDateString()} - ${end.toDateString()}`;
            } else {
              document.getElementById("dates").textContent = "Not defined";
            }
          } catch (e) {
            console.error(e);
          }
        }

        function escapeHtml(s) {
          return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        function showError(msg) {
          document.getElementById('error-text').textContent = msg;
          document.getElementById('error-message').style.display = 'flex';
          document.getElementById('success-message').style.display = 'none';
        }

        function showSuccess(msg) {
          document.getElementById('success-text').textContent = msg;
          document.getElementById('success-message').style.display = 'flex';
          document.getElementById('error-message').style.display = 'none';
        }

        async function loadCandidates() {
          try {
            const res = await fetch("http://127.0.0.1:8000/candidates", { headers });
            const data = await res.json();
            const candidatesList = document.getElementById("candidatesList");
            candidatesList.innerHTML = "";
            (data.candidates || []).forEach(c => {
              const card = document.createElement("div");
              card.className = "candidate-card";
              card.innerHTML = `
                <input type="radio" name="candidate" value="${c.id}" id="c${c.id}">
                <label for="c${c.id}" class="candidate-content">
                  <div class="candidate-info">
                    <div class="info-row">
                      <span class="info-label">Candidate Name:</span>
                      <span class="info-value">${escapeHtml(c.name)}</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">Candidate Party:</span>
                      <span class="info-value">${escapeHtml(c.party)}</span>
                    </div>
                  </div>
                  <div class="candidate-votes">
                    <div class="votes-number">${c.vote_count}</div>
                    <div class="votes-label">Votes</div>
                  </div>
                </label>
              `;
              candidatesList.appendChild(card);
            });
          } catch (e) {
            console.error(e);
            showError('Failed to load candidates');
          }
        }

        async function getWalletAddress() {
          try {
            if (window.ethereum) {
              const accounts = await window.ethereum.request({ method: 'eth_accounts' });
              return accounts[0] || null;
            }
          } catch (e) {
            console.error('Error getting wallet address:', e);
          }
          return null;
        }

        async function checkVoted() {
          try {
            const walletAddress = await getWalletAddress();
            const res = await fetch("http://127.0.0.1:8000/has-voted", { 
              method: 'POST',
              headers: { ...headers, 'Content-Type': 'application/json' },
              body: JSON.stringify({ walletAddress: walletAddress || '' })
            });
            const data = await res.json();
            const castBtn = document.getElementById('castVoteBtn');
            if (data.hasVoted) {
              showError('You have already voted.');
              castBtn.disabled = true;
              castBtn.style.display = 'none';
            } else {
              castBtn.style.display = 'flex';
              castBtn.disabled = false;
            }
          } catch (e) {
            console.error(e);
          }
        }

        async function submitVote() {
          const selected = document.querySelector("input[name='candidate']:checked");
          if (!selected) {
            showError('Please select a candidate.');
            return;
          }
          try {
            const walletAddress = await getWalletAddress();
            if (!walletAddress) {
              showError('Please connect your wallet first.');
              return;
            }
            const res = await fetch("http://127.0.0.1:8000/vote", {
              method: "POST",
              headers: { ...headers, "Content-Type": "application/json" },
              body: JSON.stringify({ 
                candidateId: parseInt(selected.value),
                walletAddress: walletAddress
              })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || "Failed to vote");
            showSuccess('Vote cast successfully!');
            document.getElementById('castVoteBtn').disabled = true;
            document.getElementById('castVoteBtn').style.display = 'none';
            await loadCandidates();
            await checkVoted();
          } catch (e) {
            console.error(e);
            showError(e.message);
          }
        }

        window.addEventListener("load", () => {
          loadDates();
          loadCandidates();
          checkVoted();
          
          // Listen for MetaMask account changes
          if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
              console.log('Account changed:', accounts[0]);
              checkVoted();
              document.getElementById('error-message').style.display = 'none';
              document.getElementById('success-message').style.display = 'none';
            });
          }
          
          document.getElementById('castVoteBtn').addEventListener('click', submitVote);
          
          document.addEventListener('change', (e) => {
            if (e.target.name === 'candidate') {
              document.getElementById('error-message').style.display = 'none';
              document.getElementById('success-message').style.display = 'none';
            }
          });
        });
    </script>
    <script src="../js/index.js" type="module"></script>
</body>
</html>
